{% extends "base.html" %}

{% block title %}üéì –°–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤ –ø–æ–≤—ã—à–µ–Ω–∏—è –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-mortarboard"></i> –°–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤ –ø–æ–≤—ã—à–µ–Ω–∏—è –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏</h2>
    <div>
        <a href="{{ url_for('add_course') }}" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –∫—É—Ä—Å
        </a>
        <a href="{{ url_for('export_pdf', report_type='courses', report_name='all') }}" class="btn btn-outline-primary">
            <i class="bi bi-file-earmark-pdf"></i> –≠–∫—Å–ø–æ—Ä—Ç PDF
        </a>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3" id="filterForm">
            <div class="col-md-3">
                <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <select class="form-select" name="status">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω</option>
                    <option value="–ù–∞–±–æ—Ä">–ù–∞–±–æ—Ä</option>
                    <option value="–í –ø—Ä–æ—Ü–µ—Å—Å–µ">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                    <option value="–ó–∞–≤–µ—Ä—à–µ–Ω">–ó–∞–≤–µ—Ä—à–µ–Ω</option>
                    <option value="–û—Ç–º–µ–Ω–µ–Ω">–û—Ç–º–µ–Ω–µ–Ω</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</label>
                <input type="text" class="form-control" name="teacher" placeholder="–§–ò–û –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è">
            </div>
            <div class="col-md-3">
                <label class="form-label">–ö–æ–¥ –∫—É—Ä—Å–∞</label>
                <input type="text" class="form-control" name="code" placeholder="COURSE...">
            </div>
            <div class="col-md-3">
                <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select class="form-select" name="category">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    <option value="–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π</option>
                    <option value="–ì—É–º–∞–Ω–∏—Ç–∞—Ä–Ω—ã–π">–ì—É–º–∞–Ω–∏—Ç–∞—Ä–Ω—ã–π</option>
                    <option value="–£–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–π">–£–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–π</option>
                    <option value="–û–±—â–∏–π">–û–±—â–∏–π</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ (–æ—Ç)</label>
                <input type="date" class="form-control" name="date_from">
            </div>
            <div class="col-md-6">
                <label class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ (–¥–æ)</label>
                <input type="date" class="form-control" name="date_to">
            </div>
            <div class="col-12">
                <div class="d-flex justify-content-between">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-funnel"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetFilters()">
                        <i class="bi bi-x-circle"></i> –°–±—Ä–æ—Å–∏—Ç—å
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –∫—É—Ä—Å–æ–≤ -->
<div class="row">
    {% for course in courses %}
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">{{ course.course_name }}</h5>
                    <small class="text-muted">–ö–æ–¥: {{ course.course_code }}</small>
                </div>
                <div>
                    {% if course.status == '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω' %}
                        <span class="badge bg-info">{{ course.status }}</span>
                    {% elif course.status == '–ù–∞–±–æ—Ä' %}
                        <span class="badge bg-primary">{{ course.status }}</span>
                    {% elif course.status == '–í –ø—Ä–æ—Ü–µ—Å—Å–µ' %}
                        <span class="badge bg-warning">{{ course.status }}</span>
                    {% elif course.status == '–ó–∞–≤–µ—Ä—à–µ–Ω' %}
                        <span class="badge bg-success">{{ course.status }}</span>
                    {% elif course.status == '–û—Ç–º–µ–Ω–µ–Ω' %}
                        <span class="badge bg-danger">{{ course.status }}</span>
                    {% else %}
                        <span class="badge bg-secondary">{{ course.status }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="card-subtitle mb-2 text-muted">
                        <i class="bi bi-person"></i> –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: {{ course.teacher.name }}
                    </h6>
                    <p class="card-text mb-1">
                        <i class="bi bi-building"></i> {{ course.teacher.department }}
                    </p>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="card-text">
                            <i class="bi bi-calendar-event"></i> 
                            <strong>–î–∞—Ç—ã:</strong><br>
                            {{ course.dates.start_date }} - {{ course.dates.end_date }}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p class="card-text">
                            <i class="bi bi-clock"></i> 
                            <strong>–ß–∞—Å—ã:</strong> {{ course.hours }}<br>
                            <i class="bi bi-currency-exchange"></i> 
                            <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> {{ course.price|default(0, true) }} —Ä—É–±.
                        </p>
                    </div>
                </div>
                
                {% if course.employees %}
                <div class="mb-3">
                    <h6>–ó–∞–ø–∏—Å–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ ({{ course.employees|length }}/3):</h6>
                    <div class="list-group list-group-flush">
                        {% for emp in course.employees %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <strong>{{ emp.name }}</strong>
                                <small>{{ emp.position }}</small>
                            </div>
                            {% if emp.department %}
                            <small class="text-muted">{{ emp.department }}</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if course.description %}
                <div class="mb-3">
                    <h6>–û–ø–∏—Å–∞–Ω–∏–µ:</h6>
                    <p class="card-text">{{ course.description[:150] }}{% if course.description|length > 150 %}...{% endif %}</p>
                </div>
                {% endif %}
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="bi bi-calendar-plus"></i> 
                        –°–æ–∑–¥–∞–Ω: {{ course.created_at.strftime('%d.%m.%Y %H:%M') if course.created_at else '–ù/–î' }}
                    </small>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <a href="{{ url_for('view_course', id=course._id) }}" class="btn btn-sm btn-info">
                            <i class="bi bi-eye"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </a>
                    </div>
                    <div class="action-buttons">
                        <a href="{{ url_for('edit_course', id=course._id) }}" class="btn btn-sm btn-warning">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{{ url_for('delete_course', id=course._id) }}" 
                           class="btn btn-sm btn-danger" 
                           onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫—É—Ä—Å?')">
                            <i class="bi bi-trash"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-md-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="bi bi-mortarboard" style="font-size: 3rem; color: #6c757d;"></i>
                <h4 class="mt-3">–ö—É—Ä—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
                <p class="text-muted">–ù–µ—Ç –∫—É—Ä—Å–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –∫—É—Ä—Å!</p>
                <a href="{{ url_for('add_course') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –∫—É—Ä—Å
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
{% if courses and courses|length > 0 %}
<div class="card mt-4">
    <div class="card-body">
        <h5 class="card-title"><i class="bi bi-graph-up"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—É—Ä—Å–æ–≤</h5>
        <div class="row">
            <div class="col-md-3 text-center">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">–í—Å–µ–≥–æ –∫—É—Ä—Å–æ–≤</h6>
                        <p class="card-text display-6">{{ courses|length }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö</h6>
                        <p class="card-text display-6">
                            {% set upcoming = courses|selectattr('status', 'equalto', '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω')|list|length %}
                            {{ upcoming + courses|selectattr('status', 'equalto', '–ù–∞–±–æ—Ä')|list|length }}
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">–û–±—â–µ–µ –∫–æ–ª-–≤–æ —á–∞—Å–æ–≤</h6>
                        <p class="card-text display-6">
                            {{ courses|sum(attribute='hours') }}
                            <small class="text-muted">—á–∞—Å–æ–≤</small>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h6>
                        <p class="card-text display-6">
                            {{ courses|sum_employees }}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- –ö–Ω–æ–ø–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
<div class="fixed-bottom text-end p-3">
    <a href="{{ url_for('add_course') }}" class="btn btn-success btn-lg rounded-pill shadow-lg" 
       style="width: 60px; height: 60px;" title="–î–æ–±–∞–≤–∏—Ç—å –∫—É—Ä—Å">
        <i class="bi bi-plus" style="font-size: 1.5rem;"></i>
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
function resetFilters() {
    document.getElementById('filterForm').reset();
    document.getElementById('filterForm').submit();
}
</script>
{% endblock %}