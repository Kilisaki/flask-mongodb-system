{% extends "base.html" %}

{% block title %}{{ action }} курс{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid var(--success-color);
    }
    
    .employee-card {
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        position: relative;
    }
    
    .remove-employee {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    
    .hour-input::after {
        content: "часов";
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }
    
    .price-input::after {
        content: "руб.";
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }
    
    .participants-input::after {
        content: "чел.";
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2><i class="bi bi-mortarboard"></i> {{ action }} курс повышения квалификации</h2>
        
        {% if errors %}
        <div class="alert alert-danger alert-permanent">
            <h5><i class="bi bi-exclamation-triangle-fill"></i> Обнаружены ошибки:</h5>
            <ul class="mb-0">
                {% for error in errors %}
                <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        
        <form method="POST" class="mt-4" id="courseForm" novalidate>
            <!-- Секция 1: Основная информация -->
            <div class="form-section">
                <h4><i class="bi bi-info-circle"></i> Основная информация</h4>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label class="form-label required">Название курса</label>
                            <input type="text" class="form-control" name="course_name" 
                                   value="{{ course.course_name if course else '' }}" 
                                   required minlength="5" maxlength="200">
                            <div class="form-text">Минимум 5 символов</div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Категория</label>
                            <select class="form-select" name="category">
                                <option value="Общий" {% if course and course.category == 'Общий' %}selected{% endif %}>Общий</option>
                                <option value="Технический" {% if course and course.category == 'Технический' %}selected{% endif %}>Технический</option>
                                <option value="Гуманитарный" {% if course and course.category == 'Гуманитарный' %}selected{% endif %}>Гуманитарный</option>
                                <option value="Управленческий" {% if course and course.category == 'Управленческий' %}selected{% endif %}>Управленческий</option>
                                <option value="IT" {% if course and course.category == 'IT' %}selected{% endif %}>IT</option>
                                <option value="Бизнес" {% if course and course.category == 'Бизнес' %}selected{% endif %}>Бизнес</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3 hour-input" style="position: relative;">
                            <label class="form-label required">Количество часов</label>
                            <input type="number" class="form-control" name="hours" 
                                   value="{{ course.hours if course else '' }}" 
                                   required min="1" max="1000">
                            <div class="form-text">От 1 до 1000 часов</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3 price-input" style="position: relative;">
                            <label class="form-label">Стоимость курса (руб.)</label>
                            <input type="number" step="0.01" min="0" max="1000000" 
                                   class="form-control" name="price" 
                                   value="{{ course.price if course else '0' }}">
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Место проведения</label>
                    <input type="text" class="form-control" name="location" 
                           value="{{ course.location if course else '' }}" 
                           maxlength="200">
                    <div class="form-text">Адрес или онлайн-платформа</div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Описание курса</label>
                    <textarea class="form-control" name="description" rows="4"
                              maxlength="2000">{{ course.description if course else '' }}</textarea>
                    <div class="form-text">Опишите содержание курса, цели и задачи (макс. 2000 символов)</div>
                </div>
            </div>
            
            <!-- Секция 2: Информация о преподавателе -->
            <div class="form-section">
                <h4><i class="bi bi-person-badge"></i> Информация о преподавателе</h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">ФИО преподавателя</label>
                            <input type="text" class="form-control" name="teacher_name" 
                                   value="{{ course.teacher_name if course else '' }}" 
                                   required minlength="2" maxlength="100">
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">Отдел/Кафедра</label>
                            <input type="text" class="form-control" name="teacher_department" 
                                   value="{{ course.teacher_department if course else '' }}" 
                                   required minlength="2" maxlength="100">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Квалификация</label>
                            <input type="text" class="form-control" name="teacher_qualification" 
                                   value="{{ course.teacher_qualification if course else '' }}" 
                                   maxlength="200">
                            <div class="form-text">Ученая степень, звание</div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="teacher_email" 
                                   value="{{ course.teacher_email if course else '' }}" 
                                   pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$">
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Телефон</label>
                            <input type="tel" class="form-control" name="teacher_phone" 
                                   value="{{ course.teacher_phone if course else '' }}" 
                                   pattern="(\+7|8)\d{10}">
                            <div class="form-text">Формат: +7XXXXXXXXXX</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Секция 3: Даты проведения -->
            <div class="form-section">
                <h4><i class="bi bi-calendar-event"></i> Даты проведения</h4>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label required">Дата начала</label>
                            <input type="date" class="form-control" name="start_date" 
                                   value="{{ course.start_date if course else '' }}" 
                                   required min="{{ today }}">
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label required">Дата окончания</label>
                            <input type="date" class="form-control" name="end_date" 
                                   value="{{ course.end_date if course else '' }}" required>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Дедлайн регистрации</label>
                            <input type="date" class="form-control" name="registration_deadline" 
                                   value="{{ course.registration_deadline if course else '' }}">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3 participants-input" style="position: relative;">
                            <label class="form-label">Макс. количество участников</label>
                            <input type="number" class="form-control" name="max_participants" 
                                   value="{{ course.max_participants if course else '30' }}" 
                                   min="1" max="1000">
                            <div class="form-text">От 1 до 1000 человек</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required">Статус курса</label>
                            <select class="form-select" name="status" required>
                                <option value="">Выберите статус</option>
                                <option value="Запланирован" {% if course and course.status == 'Запланирован' %}selected{% endif %}>Запланирован</option>
                                <option value="Набор" {% if course and course.status == 'Набор' %}selected{% endif %}>Набор</option>
                                <option value="В процессе" {% if course and course.status == 'В процессе' %}selected{% endif %}>В процессе</option>
                                <option value="Завершен" {% if course and course.status == 'Завершен' %}selected{% endif %}>Завершен</option>
                                <option value="Отменен" {% if course and course.status == 'Отменен' %}selected{% endif %}>Отменен</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Секция 4: Сотрудники (до 3 человек) -->
            <div class="form-section">
                <h4><i class="bi bi-people"></i> Записанные сотрудники (до 3 человек)</h4>
                
                <div id="employees-container">
                    {% for i in range(1, 4) %}
                    <div class="employee-card" id="employee-{{ i }}">
                        <h6>Сотрудник {{ i }}</h6>
                        {% if i > 1 %}
                        <button type="button" class="btn btn-sm btn-danger remove-employee" 
                                onclick="removeEmployee({{ i }})">
                            <i class="bi bi-trash"></i>
                        </button>
                        {% endif %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ФИО</label>
                                    <input type="text" class="form-control employee-name" 
                                           name="employee_{{ i }}_name" 
                                           value="{{ course['employee_' ~ i ~ '_name'] if course else '' }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Должность</label>
                                    <input type="text" class="form-control employee-position" 
                                           name="employee_{{ i }}_position" 
                                           value="{{ course['employee_' ~ i ~ '_position'] if course else '' }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Отдел</label>
                                    <input type="text" class="form-control employee-department" 
                                           name="employee_{{ i }}_department" 
                                           value="{{ course['employee_' ~ i ~ '_department'] if course else '' }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control employee-email" 
                                           name="employee_{{ i }}_email" 
                                           value="{{ course['employee_' ~ i ~ '_email'] if course else '' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="mt-3">
                    <button type="button" id="add-employee" class="btn btn-secondary btn-sm">
                        <i class="bi bi-plus-circle"></i> Добавить еще сотрудника
                    </button>
                    <small class="text-muted ms-2">Максимум 3 сотрудника</small>
                </div>
            </div>
            
            <!-- Кнопки -->
            <div class="d-flex justify-content-between align-items-center mt-4 pt-4 border-top">
                <div>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="bi bi-check-circle"></i> {{ action }}
                    </button>
                    <a href="{{ url_for('courses_list') }}" class="btn btn-secondary btn-lg ms-2">
                        <i class="bi bi-x-circle"></i> Отмена
                    </a>
                </div>
                <div>
                    <button type="button" class="btn btn-outline-info" onclick="validateCourseForm()">
                        <i class="bi bi-check-all"></i> Проверить данные
                    </button>
                    <button type="button" class="btn btn-outline-primary ms-2" onclick="generateCourseCode()">
                        <i class="bi bi-braces"></i> Сгенерировать код
                    </button>
                </div>
            </div>
            
            <div class="mt-3 text-muted">
                <small><i class="bi bi-info-circle"></i> Поля, отмеченные *, обязательны для заполнения</small>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    let employeeCount = {{ course.employees|length if course else 1 }};
    
    // Устанавливаем минимальные даты
    const startDate = document.querySelector('input[name="start_date"]');
    const endDate = document.querySelector('input[name="end_date"]');
    const regDeadline = document.querySelector('input[name="registration_deadline"]');
    
    if (startDate && !startDate.value) {
        // По умолчанию через неделю
        const nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 7);
        startDate.value = nextWeek.toISOString().split('T')[0];
    }
    
    if (endDate && !endDate.value && startDate.value) {
        // По умолчанию через месяц от начала
        const monthLater = new Date(startDate.value);
        monthLater.setDate(monthLater.getDate() + 30);
        endDate.value = monthLater.toISOString().split('T')[0];
    }
    
    if (regDeadline && !regDeadline.value && startDate.value) {
        // По умолчанию за 3 дня до начала
        const threeDaysBefore = new Date(startDate.value);
        threeDaysBefore.setDate(threeDaysBefore.getDate() - 3);
        regDeadline.value = threeDaysBefore.toISOString().split('T')[0];
    }
    
    // Проверка дат
    if (startDate && endDate) {
        startDate.addEventListener('change', function() {
            endDate.min = this.value;
            if (endDate.value && endDate.value < this.value) {
                alert('Дата окончания не может быть раньше даты начала!');
                endDate.value = this.value;
            }
            
            // Обновляем дедлайн регистрации
            if (regDeadline) {
                const threeDaysBefore = new Date(this.value);
                threeDaysBefore.setDate(threeDaysBefore.getDate() - 3);
                regDeadline.max = this.value;
                regDeadline.value = threeDaysBefore.toISOString().split('T')[0];
            }
        });
        
        endDate.addEventListener('change', function() {
            if (this.value < startDate.value) {
                alert('❌ Ошибка: Дата окончания не может быть раньше даты начала!');
                this.value = startDate.value;
            }
        });
        
        if (regDeadline) {
            regDeadline.addEventListener('change', function() {
                if (this.value > startDate.value) {
                    alert('❌ Ошибка: Дедлайн регистрации не может быть позже даты начала курса!');
                    const threeDaysBefore = new Date(startDate.value);
                    threeDaysBefore.setDate(threeDaysBefore.getDate() - 3);
                    this.value = threeDaysBefore.toISOString().split('T')[0];
                }
            });
        }
    }
    
    // Управление сотрудниками
    const addButton = document.getElementById('add-employee');
    const container = document.getElementById('employees-container');
    
    addButton.addEventListener('click', function() {
        if (employeeCount >= 3) {
            alert('Максимальное количество сотрудников - 3');
            return;
        }
        
        employeeCount++;
        const newEmployeeId = employeeCount;
        
        const newEmployeeCard = document.createElement('div');
        newEmployeeCard.className = 'employee-card';
        newEmployeeCard.id = `employee-${newEmployeeId}`;
        
        newEmployeeCard.innerHTML = `
            <h6>Сотрудник ${newEmployeeId}</h6>
            <button type="button" class="btn btn-sm btn-danger remove-employee" 
                    onclick="removeEmployee(${newEmployeeId})">
                <i class="bi bi-trash"></i>
            </button>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">ФИО</label>
                        <input type="text" class="form-control employee-name" 
                               name="employee_${newEmployeeId}_name">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Должность</label>
                        <input type="text" class="form-control employee-position" 
                               name="employee_${newEmployeeId}_position">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Отдел</label>
                        <input type="text" class="form-control employee-department" 
                               name="employee_${newEmployeeId}_department">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control employee-email" 
                               name="employee_${newEmployeeId}_email">
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(newEmployeeCard);
        
        // Отключаем кнопку если достигли максимума
        if (employeeCount >= 3) {
            addButton.disabled = true;
            addButton.innerHTML = '<i class="bi bi-dash-circle"></i> Максимум достигнут';
        }
    });
    
    // Проверяем сколько сотрудников уже заполнено
    updateEmployeeButtons();
    
    // Валидация формы на стороне клиента
    const form = document.getElementById('courseForm');
    form.addEventListener('submit', function(event) {
        if (!validateCourseForm()) {
            event.preventDefault();
        }
    });
});

function removeEmployee(employeeId) {
    const employeeCard = document.getElementById(`employee-${employeeId}`);
    if (employeeCard) {
        employeeCard.remove();
        employeeCount--;
        
        // Обновляем номера оставшихся сотрудников
        updateEmployeeNumbers();
        
        // Включаем кнопку добавления
        const addButton = document.getElementById('add-employee');
        addButton.disabled = false;
        addButton.innerHTML = '<i class="bi bi-plus-circle"></i> Добавить еще сотрудника';
    }
}

function updateEmployeeNumbers() {
    const cards = document.querySelectorAll('.employee-card');
    cards.forEach((card, index) => {
        const employeeNumber = index + 1;
        card.id = `employee-${employeeNumber}`;
        card.querySelector('h6').textContent = `Сотрудник ${employeeNumber}`;
        
        // Обновляем имена полей
        const inputs = card.querySelectorAll('input');
        inputs.forEach((input, i) => {
            const fieldNames = ['name', 'position', 'department', 'email'];
            if (fieldNames[i]) {
                input.name = `employee_${employeeNumber}_${fieldNames[i]}`;
            }
        });
        
        // Обновляем обработчик удаления
        const removeBtn = card.querySelector('.remove-employee');
        if (removeBtn) {
            removeBtn.setAttribute('onclick', `removeEmployee(${employeeNumber})`);
        }
    });
    
    employeeCount = cards.length;
    updateEmployeeButtons();
}

function updateEmployeeButtons() {
    const addButton = document.getElementById('add-employee');
    if (employeeCount >= 3) {
        addButton.disabled = true;
        addButton.innerHTML = '<i class="bi bi-dash-circle"></i> Максимум достигнут';
    } else {
        addButton.disabled = false;
        addButton.innerHTML = '<i class="bi bi-plus-circle"></i> Добавить еще сотрудника';
    }
    
    // Скрываем кнопку удаления у первого сотрудника
    const firstEmployee = document.getElementById('employee-1');
    if (firstEmployee) {
        const removeBtn = firstEmployee.querySelector('.remove-employee');
        if (removeBtn) {
            removeBtn.style.display = employeeCount > 1 ? 'block' : 'none';
        }
    }
}

function validateCourseForm() {
    const form = document.getElementById('courseForm');
    let isValid = true;
    const errors = [];
    
    // Проверка названия курса
    const courseName = form.querySelector('input[name="course_name"]').value.trim();
    if (courseName.length < 5) {
        errors.push('Название курса должно содержать минимум 5 символов');
        isValid = false;
    }
    
    // Проверка количества часов
    const hours = parseInt(form.querySelector('input[name="hours"]').value);
    if (hours <= 0 || hours > 1000) {
        errors.push('Количество часов должно быть от 1 до 1000');
        isValid = false;
    }
    
    // Проверка дат
    const startDate = new Date(form.querySelector('input[name="start_date"]').value);
    const endDate = new Date(form.querySelector('input[name="end_date"]').value);
    const today = new Date();
    
    if (startDate < today) {
        errors.push('Дата начала не может быть в прошлом');
        isValid = false;
    }
    
    if (endDate < startDate) {
        errors.push('Дата окончания не может быть раньше даты начала');
        isValid = false;
    }
    
    // Проверка стоимости
    const price = parseFloat(form.querySelector('input[name="price"]').value);
    if (price < 0) {
        errors.push('Стоимость не может быть отрицательной');
        isValid = false;
    }
    
    // Проверка максимального количества участников
    const maxParticipants = parseInt(form.querySelector('input[name="max_participants"]').value);
    if (maxParticipants <= 0) {
        errors.push('Максимальное количество участников должно быть больше 0');
        isValid = false;
    }
    
    // Проверка сотрудников
    let hasEmployees = false;
    for (let i = 1; i <= employeeCount; i++) {
        const name = form.querySelector(`input[name="employee_${i}_name"]`)?.value.trim();
        const position = form.querySelector(`input[name="employee_${i}_position"]`)?.value.trim();
        
        if (name && position) {
            hasEmployees = true;
            if (name.length < 2) {
                errors.push(`ФИО сотрудника ${i} должно содержать минимум 2 символа`);
                isValid = false;
            }
            if (position.length < 2) {
                errors.push(`Должность сотрудника ${i} должна содержать минимум 2 символа`);
                isValid = false;
            }
        } else if ((name && !position) || (!name && position)) {
            errors.push(`Для сотрудника ${i} необходимо заполнить и ФИО и должность`);
            isValid = false;
        }
    }
    
    if (!hasEmployees) {
        errors.push('Необходимо указать хотя бы одного сотрудника');
        isValid = false;
    }
    
    if (!isValid) {
        alert('Обнаружены ошибки:\n' + errors.join('\n'));
        return false;
    } else {
        alert('✅ Все данные корректны! Можно отправлять форму.');
        return true;
    }
}

function generateCourseCode() {
    // Генерация кода курса по шаблону: COURSEYYMMXXX
    const now = new Date();
    const year = now.getFullYear().toString().slice(-2);
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const random = Math.random().toString(36).substring(2, 5).toUpperCase();
    
    const courseCode = `COURSE${year}${month}${random}`;
    
    // Показываем код курса
    alert(`Сгенерирован код курса: ${courseCode}\n\nЭтот код будет автоматически присвоен при сохранении курса.`);
}
</script>
{% endblock %}